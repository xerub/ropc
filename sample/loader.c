#define _GNU_SOURCE
#include <assert.h>
#include <dlfcn.h>
#include <fcntl.h>
#include <stdarg.h>
#include <stdint.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <sys/stat.h>
#include <unistd.h>
#ifdef __APPLE__
#include <mach-o/dyld.h>
#endif

#define SPACE 0x10000

#define GADGET(name, insns) \
extern char name[]; \
__asm(".p2align 2\n" \
	".globl	_gadget_" #name "\n" \
"_gadget_" #name ":\n" \
insns)

#ifdef __x86_64__
GADGET(LDR_RAX,
	".byte	0x58, 0xC3\n"
);
GADGET(LDR_RCX,
	".byte	0x59, 0xC3\n"
);
GADGET(LDR_RDX,
	".byte	0x5A, 0xC3\n"
);
GADGET(LDR_RBX,
	".byte	0x5B, 0xC3\n"
);
GADGET(LDR_RBP,
	".byte	0x5D, 0xC3\n"
);
GADGET(LDR_RSI,
	".byte	0x5E, 0xC3\n"
);
GADGET(LDR_RDI,
	".byte	0x5F, 0xC3\n"
);
GADGET(LDR_R8,
	".byte	0x41, 0x58, 0xC3\n"
);
GADGET(LDR_R9,
	".byte	0x41, 0x59, 0xC3\n"
);
GADGET(LDR_RAX_RAX,
	".byte	0x48, 0x8B, 0x00, 0xC3\n"
);
GADGET(STR_RAX_RBX,
	".byte	0x48, 0x89, 0x03, 0x5B, 0xC3\n"
	".byte	0x48, 0x89, 0x03, 0x48, 0x83, 0xC4, 0x08, 0x5B, 0x5D, 0xC3\n"
);
GADGET(MOV_RDI_RAX,
	".byte	0x48, 0x89, 0xC7, 0x48, 0x89, 0xF8, 0x5D, 0xC3\n"
	".byte	0x48, 0x89, 0xC7, 0x5B, 0x5D, 0x41, 0x5C, 0xFF, 0xE1\n" // XXX
	".byte	0x48, 0x89, 0xC7, 0x48, 0x8B, 0x49, 0x08, 0xFF, 0xE1\n"
);
GADGET(MOV_RAX_RDI,
	".byte	0x48, 0x89, 0xF8, 0xC3\n"
);
GADGET(OR_RAX_reg,
	".byte	0x48, 0x09, 0xD0, 0xC3\n"
	".byte	0x48, 0x09, 0xD0, 0x5D, 0xC3\n"
);
GADGET(XOR_RAX_reg,
	".byte	0x48, 0x31, 0xD0, 0xC3\n"
);
GADGET(AND_RAX_reg,
	".byte	0x48, 0x21, 0xF0, 0x5D, 0xC3\n"
	".byte	0x48, 0x21, 0xD0, 0x66, 0x48, 0x0F, 0x6E, 0xC0, 0xC3\n"
);
GADGET(ADD_RAX_reg,
	".byte	0x48, 0x01, 0xC8, 0xC3\n"
	".byte	0x48, 0x01, 0xD0, 0x5D, 0xC3\n"
);
GADGET(SUB_RAX_reg,
	".byte	0x48, 0x29, 0xD0, 0xC3\n"
	".byte	0x48, 0x29, 0xC8, 0x5D, 0xC3\n"
);
GADGET(MUL_RAX_reg,
	".byte	0x48, 0xF7, 0xE6, 0x4C, 0x01, 0xC2, 0xC3\n"
	".byte	0x48, 0xF7, 0xE2, 0x4C, 0x01, 0xC2, 0x48, 0x01, 0xFA, 0xC3\n"
);
GADGET(DIV_RAX_reg,
	".byte	0x48, 0xF7, 0xF3, 0x5B, 0x5D, 0xC3\n"
	".byte	0x48, 0xF7, 0xF1, 0x48, 0x0F, 0xAF, 0xC7, 0xEB, 0x02, 0x31, 0xC0, 0x5D, 0xC3\n"
);
GADGET(MUL_RAX_TWO,
	".byte	0x48, 0x8D, 0x44, 0x00, 0xFF, 0xC3\n"
);
GADGET(BLR_RAX,
	".byte	0xFF, 0xD0, 0x48, 0x83, 0xC4, 0x20, 0x5D, 0xC3\n"
	".byte	0xFF, 0xD0, 0x48, 0x83, 0xC4, 0x38, 0xC3\n"
);
GADGET(COMMUTE,
	".byte	0x48, 0x89, 0xEC, 0x5D, 0xC3\n"
	".byte	0xC9, 0xC3\n"
);
GADGET(SELECT,
	".byte	0x48, 0x85, 0xC0, 0x48, 0x89, 0xD0, 0x48, 0x0F, 0x44, 0xC3, 0x5B, 0xC3\n"
	".byte	0x48, 0x85, 0xC0, 0x48, 0x0F, 0x44, 0xCA, 0x48, 0x89, 0xC8, 0x5B, 0x41, 0x5C, 0x41, 0x5E, 0x41, 0x5F, 0x5D, 0xC3\n"
);
#elif defined(__i386__)
GADGET(LDR_EAX,
	".byte	0x58, 0xC3\n"
);
GADGET(LDR_ECX,
	".byte	0x59, 0xC3\n"
);
GADGET(LDR_EDX,
	".byte	0x5A, 0xC3\n"
	".byte	0x5A, 0x5D, 0xC3\n"
);
GADGET(LDR_EBX,
	".byte	0x5B, 0xC3\n"
);
GADGET(LDR_EBP,
	".byte	0x5D, 0xC3\n"
);
GADGET(LDR_ESI,
	".byte	0x5E, 0xC3\n"
);
GADGET(LDR_EDI,
	".byte	0x5F, 0xC3\n"
);
GADGET(LDR_EAX_EAX,
	".byte	0x8B, 0x00, 0xC3\n"
);
GADGET(STR_EAX_ECX,
	".byte	0x89, 0x01, 0xC3\n"
	".byte	0x89, 0x01, 0x5B, 0xC3\n"
);
GADGET(MOV_EDX_EAX,
	".byte	0x89, 0xC2, 0xC3\n"
	".byte	0x89, 0xC2, 0x5B, 0x89, 0xD0, 0x5E, 0x5F, 0x5D, 0xC3\n"
);
GADGET(MOV_EAX_EDX,
	".byte	0x89, 0xD0, 0xC3\n"
);
GADGET(OR_EAX_reg,
	".byte	0x09, 0xC8, 0x5D, 0xC3\n"
	".byte	0x09, 0xC8, 0x5B, 0xC3\n"
);
GADGET(XOR_EAX_reg,
	".byte	0x31, 0xC8, 0xC3\n"
);
GADGET(AND_EAX_reg,
	".byte	0x21, 0xC8, 0xC3\n"
	".byte	0x21, 0xC8, 0x5D, 0xC3\n"
);
GADGET(ADD_EAX_reg,
	".byte	0x01, 0xC8, 0xC3\n"
);
GADGET(SUB_EAX_reg,
	".byte	0x29, 0xC8, 0xC3\n"
);
GADGET(MUL_EAX_reg,
	".byte	0xF7, 0xE2, 0x01, 0xCB, 0x01, 0xDA, 0x5B, 0xC3\n"
);
GADGET(DIV_EAX_reg,
	".byte	0xF7, 0xF1, 0x89, 0xDA, 0x5B, 0xC3\n"
	".byte	0xF7, 0xF6, 0x5B, 0x5E, 0x5F, 0x01, 0xC8, 0xC3\n"
);
GADGET(MUL_EAX_TWO,
	".byte	0x8D, 0x44, 0x00, 0xFF, 0xC3\n"
);
GADGET(BLR_EAX_2,
	".byte	0xFF, 0xD0, 0x83, 0xC4, 0x08, 0x5D, 0xC3\n"
	".byte	0xFF, 0xD0, 0x83, 0xC4, 0x0C, 0xC3\n"
);
GADGET(BLR_EAX_6,
	".byte	0xFF, 0xD0, 0x83, 0xC4, 0x18, 0x5D, 0xC3\n"
	".byte	0xFF, 0xD0, 0x83, 0xC4, 0x1C, 0xC3\n"
);
GADGET(BLR_EAX_16,
	".byte	0xFF, 0xD0, 0x83, 0xC4, 0x40, 0x5E, 0x5F, 0x5D, 0xC3\n"
);
GADGET(COMMUTE,
	".byte	0x89, 0xEC, 0x5D, 0xC3\n"
);
GADGET(SELECT,
	".byte	0x85, 0xC0, 0x0F, 0x45, 0xF1, 0x89, 0xF0, 0x83, 0xC4, 0x0C, 0x5E, 0x5F, 0x5B, 0x5D, 0xC3\n"
	".byte	0x8B, 0x04, 0x90, 0xC3\n"
);
GADGET(NOT_EAX,
	".byte	0x85, 0xC0, 0x0F, 0x94, 0xC0, 0x0F, 0xB6, 0xC0, 0xC3\n"
);
#elif defined(__arm64__)
GADGET(LDR_X0,
	".byte	0xE0, 0x03, 0x40, 0xF9, 0x00, 0x01, 0x3F, 0xD6\n"
);
GADGET(LDR_X1,
	".byte	0xE1, 0x03, 0x40, 0xF9, 0x00, 0x01, 0x3F, 0xD6\n"
);
GADGET(LDR_X2,
	".byte	0xE2, 0x03, 0x40, 0xF9, 0x00, 0x01, 0x3F, 0xD6\n"
);
GADGET(LDR_X3,
	".byte	0xE3, 0x03, 0x40, 0xF9, 0x00, 0x01, 0x3F, 0xD6\n"
);
GADGET(LDR_X19,
	".byte	0xFD, 0x7B, 0x41, 0xA9, 0xF4, 0x4F, 0xC2, 0xA8, 0xC0, 0x03, 0x5F, 0xD6\n"
);
GADGET(LDR_X29,
	".byte	0xFD, 0x7B, 0xC1, 0xA8, 0xC0, 0x03, 0x5F, 0xD6\n"
);
GADGET(RET_X8,
	".byte	0xE8, 0x07, 0x40, 0xF9, 0x00, 0x01, 0x3F, 0xD6\n"
);
GADGET(LDR_X0_X0,
	".byte	0x00, 0x00, 0x40, 0xF9, 0x00, 0x01, 0x3F, 0xD6\n"
);
GADGET(STR_X0_X19,
	".byte	0x60, 0x02, 0x00, 0xF9, 0xFD, 0x7B, 0x41, 0xA9, 0xF4, 0x4F, 0xC2, 0xA8, 0xC0, 0x03, 0x5F, 0xD6\n"
);
GADGET(MOV_X1_X0,
	".byte	0xE1, 0x03, 0x00, 0xAA, 0x00, 0x01, 0x3F, 0xD6\n"
);
GADGET(MOV_X0_X1,
	".byte	0xE0, 0x03, 0x01, 0xAA, 0x00, 0x01, 0x3F, 0xD6\n"
);
GADGET(OR_X0_reg,
	".byte	0x00, 0x00, 0x13, 0xAA, 0xFD, 0x7B, 0x42, 0xA9, 0xF4, 0x4F, 0x41, 0xA9, 0xFF, 0xC3, 0x00, 0x91, 0xC0, 0x03, 0x5F, 0xD6\n"
	".byte	0x00, 0x00, 0x13, 0xAA, 0xBF, 0x43, 0x00, 0xD1, 0xFD, 0x7B, 0x41, 0xA9, 0xF4, 0x4F, 0xC2, 0xA8, 0xC0, 0x03, 0x5F, 0xD6\n"
	".byte	0x20, 0x00, 0x00, 0xAA, 0xC0, 0x03, 0x5F, 0xD6\n"
);
GADGET(XOR_X0_reg,
	".byte	0x00, 0x00, 0x13, 0xCA, 0xFD, 0x7B, 0x41, 0xA9, 0xF4, 0x4F, 0xC2, 0xA8, 0xC0, 0x03, 0x5F, 0xD6\n"
);
GADGET(AND_X0_reg,
	".byte	0x20, 0x00, 0x00, 0x8A, 0xFD, 0x7B, 0x42, 0xA9, 0xFF, 0xC3, 0x00, 0x91, 0xC0, 0x03, 0x5F, 0xD6\n"
	".byte	0x00, 0x00, 0x13, 0x8A, 0xBF, 0x43, 0x00, 0xD1, 0xFD, 0x7B, 0x41, 0xA9, 0xF4, 0x4F, 0xC2, 0xA8, 0xC0, 0x03, 0x5F, 0xD6\n"
);
GADGET(ADD_X0_reg,
	".byte	0x00, 0x00, 0x01, 0x8B, 0xFD, 0x7B, 0xC1, 0xA8, 0xC0, 0x03, 0x5F, 0xD6\n"
);
GADGET(SUB_X0_reg,
	".byte	0x00, 0x00, 0x01, 0xCB, 0xFD, 0x7B, 0xC1, 0xA8, 0xC0, 0x03, 0x5F, 0xD6\n"
	".byte	0x00, 0x00, 0x01, 0xCB, 0xFD, 0x7B, 0x41, 0xA9, 0xFF, 0x83, 0x00, 0x91, 0xC0, 0x03, 0x5F, 0xD6\n"
);
GADGET(MUL_X0_reg,
	".byte	0x00, 0x7C, 0x13, 0x9B, 0xFD, 0x7B, 0x41, 0xA9, 0xF4, 0x4F, 0xC2, 0xA8, 0xC0, 0x03, 0x5F, 0xD6\n"
);
GADGET(DIV_X0_reg,
	".byte	0x00, 0x08, 0xD3, 0x9A, 0xFD, 0x7B, 0x41, 0xA9, 0xF4, 0x4F, 0xC2, 0xA8, 0xC0, 0x03, 0x5F, 0xD6\n"
	".byte	0x00, 0x08, 0xD3, 0x9A, 0x02, 0x00, 0x00, 0x14, 0x00, 0x00, 0x80, 0xD2, 0xFD, 0x7B, 0x41, 0xA9, 0xF4, 0x4F, 0xC2, 0xA8, 0xC0, 0x03, 0x5F, 0xD6\n"
	".byte	0x00, 0x08, 0xC1, 0x9A, 0xC0, 0x03, 0x5F, 0xD6\n"
);
GADGET(BR_X3,
	".byte	0xFD, 0x7B, 0xC1, 0xA8, 0x60, 0x00, 0x1F, 0xD6\n"
);
GADGET(BR_X16,
	".byte	0xF0, 0x03, 0x00, 0xAA, 0xE7, 0x1B, 0xC1, 0xA8, 0xE5, 0x13, 0xC1, 0xA8, 0xE3, 0x0B, 0xC1, 0xA8, 0xE1, 0x03, 0xC1, 0xA8, 0xFD, 0x7B, 0xC1, 0xA8, 0x00, 0x02, 0x1F, 0xD6\n"
);
GADGET(BLR_X19,
	".byte	0x60, 0x02, 0x3F, 0xD6, 0xFD, 0x7B, 0x42, 0xA9, 0xF4, 0x4F, 0x41, 0xA9, 0xF6, 0x57, 0xC3, 0xA8, 0xC0, 0x03, 0x5F, 0xD6\n"
);
GADGET(COMMUTE,
	".byte	0xBF, 0x03, 0x00, 0x91, 0xFD, 0x7B, 0xC1, 0xA8, 0xC0, 0x03, 0x5F, 0xD6\n"
);
GADGET(NOT_X0,
	".byte	0x1F, 0x00, 0x00, 0xF1, 0xE0, 0x17, 0x9F, 0x1A, 0xFD, 0x7B, 0x41, 0xA9, 0xF4, 0x4F, 0xC2, 0xA8, 0xC0, 0x03, 0x5F, 0xD6\n"
);
GADGET(SEL_1,
	".byte	0x73, 0x12, 0x9F, 0x9A, 0xE0, 0x03, 0x13, 0xAA, 0xFD, 0x7B, 0x41, 0xA9, 0xF4, 0x4F, 0xC2, 0xA8, 0xC0, 0x03, 0x5F, 0xD6\n"
	".byte	0x73, 0x12, 0x9F, 0x9A, 0xE0, 0x03, 0x13, 0xAA, 0xFD, 0x7B, 0x42, 0xA9, 0xF4, 0x4F, 0x41, 0xA9, 0xF6, 0x57, 0xC3, 0xA8, 0xC0, 0x03, 0x5F, 0xD6\n"
	".byte	0x73, 0x12, 0x9F, 0x9A, 0xE0, 0x03, 0x13, 0xAA, 0xFD, 0x7B, 0x42, 0xA9, 0xF4, 0x4F, 0x41, 0xA9, 0xFF, 0xC3, 0x00, 0x91, 0xC0, 0x03, 0x5F, 0xD6\n"
);
GADGET(SEL_2,
	".byte	0x73, 0x02, 0x80, 0x9A, 0xE0, 0x03, 0x13, 0xAA, 0xFD, 0x7B, 0x41, 0xA9, 0xF4, 0x4F, 0xC2, 0xA8, 0xC0, 0x03, 0x5F, 0xD6\n"
);
GADGET(PIVOT,
	".byte	0x3F, 0x00, 0x00, 0x91, 0x00, 0x00, 0x1F, 0xD6\n"
);
#elif defined(__arm__)
GADGET(LDR_R0,
	".byte	0x01, 0xBD\n"
);
GADGET(LDR_R0R1,
	".byte	0x03, 0xBD\n"
);
GADGET(LDR_R0TO3,
	".byte	0x0F, 0xBD\n"
	".p2align 2\n"
	".byte	0x0F, 0x80, 0xBD, 0xE8\n"
);
GADGET(LDR_R4,
	".byte	0x10, 0xBD\n"
);
GADGET(LDR_R4R5,
	".byte	0x30, 0xBD\n"
);
GADGET(LDR_R7,
	".byte	0x80, 0xBD\n"
	".byte	0xBD, 0xE8, 0x80, 0x80\n"
	".byte	0x80, 0xBC, 0x5D, 0xF8, 0x04, 0xEB, 0x70, 0x47\n"
	".p2align 2\n"
	".byte	0x80, 0x80, 0xBD, 0xE8\n"
);
GADGET(LDR_R0_R0,
	".byte	0x00, 0x68, 0x80, 0xBD\n"
);
GADGET(STR_R0_R4,
	".byte	0x20, 0x60, 0x90, 0xBD\n"
);
GADGET(MOV_R1_R0,
	".byte	0x01, 0x46, 0x90, 0xBD\n"
	".byte	0x01, 0x46, 0x08, 0x46, 0x80, 0xBD\n"
	".byte	0x01, 0x46, 0x80, 0xBD\n"
);
GADGET(MOV_R0_R1,
	".byte	0x08, 0x46, 0x80, 0xBD\n"
	".byte	0x08, 0x46, 0x90, 0xBD\n"
);
GADGET(OR_R0_R1,
	".byte	0x08, 0x43, 0x80, 0xBD\n"
);
GADGET(XOR_R0_R1,
	".byte	0x48, 0x40, 0x80, 0xBD\n"
);
GADGET(AND_R0_R1,
	".byte	0x08, 0x40, 0x80, 0xBD\n"
);
GADGET(ADD_R0_R1,
	".byte	0x08, 0x44, 0x80, 0xBD\n"
);
GADGET(SUB_R0_R1,
	".byte	0x40, 0x1A, 0x80, 0xBD\n"
);
GADGET(MUL_R0_R1,
	".byte	0x48, 0x43, 0x80, 0xBD\n"
);
GADGET(DIV_R0_R1,
	".byte	0xB0, 0xFB, 0xF1, 0xF0, 0x90, 0xBD\n"
	".byte	0xB0, 0xFB, 0xF1, 0xF0, 0xB0, 0xBD\n"
);
GADGET(BLX_R4,
	".byte	0xA0, 0x47, 0x90, 0xBD\n"
);
GADGET(BLX_R4_1,
	".byte	0xA0, 0x47, 0x01, 0xB0, 0x90, 0xBD\n"
);
GADGET(BLX_R4_2,
	".byte	0xA0, 0x47, 0x02, 0xB0, 0x90, 0xBD\n"
);
GADGET(BLX_R4_3,
	".byte	0xA0, 0x47, 0x03, 0xB0, 0x90, 0xBD\n"
);
GADGET(BLX_R4_4,
	".byte	0xA0, 0x47, 0x04, 0xB0, 0x90, 0xBD\n"
);
GADGET(BLX_R4_5,
	".byte	0xA0, 0x47, 0x05, 0xB0, 0x90, 0xBD\n"
);
GADGET(BLX_R4_6,
	".byte	0xA0, 0x47, 0x06, 0xB0, 0x90, 0xBD\n"
);
GADGET(COMMUTE,
	".byte	0xBD, 0x46, 0x80, 0xBD\n"
	".byte	0xBD, 0x46, 0xBD, 0xE8, 0x80, 0x80\n"
	".byte	0xBD, 0x46, 0x80, 0xBC, 0x5D, 0xF8, 0x04, 0xEB, 0x70, 0x47\n"
	".p2align 2\n"
	".byte	0x07, 0xD0, 0xA0, 0xE1, 0x80, 0x80, 0xBD, 0xE8\n"
);
GADGET(SELECT,
	".byte	0x00, 0x28, 0x08, 0xBF, 0x2C, 0x46, 0x20, 0x46, 0xB0, 0xBD\n"
);
GADGET(LDMIA_R0,
	".byte	0x11, 0xA0, 0x90, 0xE8\n"
	".byte	0x90, 0xE8, 0x11, 0xA0\n"
);
#endif

pid_t
getpid_(void)
{
    return getpid();
}

int
printf_(const char *fmt, ...)
{
    int rv;
    va_list ap;
    va_start(ap, fmt);
    rv = vprintf(fmt, ap);
    va_end(ap);
    return rv;
}

void
exit_(int status)
{
    exit(status);
}

static void __attribute__((noreturn))
pivot(char *addr)
{
#ifdef __x86_64__
    __asm __volatile(
        "movq %0, %%rsp;"
        "popq %%rbp;"
        "retq"
    ::"X"(addr));
#elif defined(__i386__)
    __asm __volatile(
        "movl %0, %%esp;"
        "popl %%ebp;"
        "ret"
    ::"X"(addr));
#elif defined(__arm64__)
    __asm __volatile("\n\
        mov sp, %0\n\
        ldp x29, x30, [sp], 0x10\n\
        ret\n\
    "::"r"(addr));
#elif defined(__arm__)
    __asm __volatile("\n\
        mov sp, %0\n\
        pop {r7, pc}\n\
    "::"r"(addr));
#endif
    __builtin_trap();
}

int
main(int argc, char **argv)
{
    int rv;
    int fd;
    char *buf;
    ssize_t sz;
    struct stat st;
    uintptr_t *end, slide = 0;
    const char *filename = "rope.bin";

    if (argc > 1 && !strcmp(argv[1], "-self")) {
#if defined(__linux__) && (defined(__pic__) || defined(__PIC__) || defined(__pie__) || defined(__PIE__))
        Dl_info info;
        rv = dladdr((void *)main, &info);
        if (rv) {
            slide = (uintptr_t)info.dli_fbase;
        }
#endif
#ifdef __APPLE__
        slide = _dyld_get_image_vmaddr_slide(0);
#endif
        argc--;
        argv++;
    } else {
#if defined(__linux__)
        slide = (uintptr_t)dlsym(RTLD_NEXT, "getpid");
        if (slide) {
            for (slide &= ~0xFFF; *(unsigned int *)slide != 0x464C457F; slide -= 0x1000) {
                continue;
            }
        }
#endif
#ifdef __APPLE__
        slide = _dyld_get_image_vmaddr_slide(1);
#endif
    }
    if (argc > 1) {
        filename = argv[1];
    }

    fd = open(filename, O_RDONLY);
    if (fd == -1) {
        perror("open");
        return -1;
    }

    rv = fstat(fd, &st);
    if (rv) {
        perror("stat");
        close(fd);
        return -1;
    }

    buf = calloc(1, SPACE + st.st_size);
    if (!buf) {
        perror("calloc");
        close(fd);
        return -1;
    }
    buf += SPACE;

    sz = read(fd, buf, st.st_size);
    if (sz != st.st_size) {
        perror("read");
        free(buf);
        close(fd);
        return -1;
    }

    close(fd);

    end = (uintptr_t *)(buf + st.st_size);
    while (*--end) {
        *(uintptr_t *)(*end + buf) += (uintptr_t)buf;
    }
    while (*--end) {
        *(uintptr_t *)(*end + buf) += slide;
    }

    printf("slide = 0x%zx, rope = %p\n", slide, (void *)buf);
    pivot(buf);
    return 0;
}
